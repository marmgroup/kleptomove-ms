---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Generalised Response: Items and all Individuals

```{r}
library(data.table)
library(ggplot2)
library(pals)

# custom functions
source("code/functional_response.R")
```


## Get data

```{r}
# read general fun response and split by sim type
data <- fread("data/data_funresp_general.csv")

# subset for max regrowth
data <- data[regrowth == max(regrowth)]

# round over more items
data[, items_round := floor_any(items, 0.01)]

# get summary
df <- data[, list(value = mean(value)),
  by = c(
    "sim_type",
    "items_round", "total_agents", "variable"
  )
]
```

```{r}
# split by sim type
df <- split(df, by = "sim_type")
```


```{r}
fig_fun_response <-
  lapply(df, function(df) {
    ggplot(df) +
      # geom_vline(xintercept = item_levels,
      #            lty = 2, lwd = 0.25)+
      geom_tile(aes(items_round, total_agents,
        fill = value
      ),
      show.legend = T
      ) +
      facet_grid(sim_type ~ variable) +
      # coord_fixed(ratio = 20)+
      scale_fill_gradientn(
        colours = (pals::cubehelix(10, r = -2.5)),
        limits = c(1e-6, 0.3),
        breaks = seq(0, 0.3, 0.1),
        na.value = NA
      ) +
      theme_bw(base_size = 8, base_family = "sans") +
      theme(
        legend.position = "top",
        # panel.grid = element_blank(),
        legend.key.height = unit(1, units = "mm"),
        legend.background = element_blank()
      ) +
      labs(
        fill = "per-captia\nintake",
        x = "# food items",
        y = "# individuals"
      )
  })

fig_fun_response <- patchwork::wrap_plots(fig_fun_response[c(
  "foragers",
  "obligate",
  "facultative",
  "random"
)],
ncol = 1,
guides = "collect"
) &
  theme(legend.position = "top")
fig_fun_response
# fig_fun_response[[3]]
```

```{r}
ggsave(fig_fun_response,
  filename = "figures/fig_fun_response_general.png",
  dpi = 150
)
```

## Coefficient of resources and competition

We fit a GLM with per-capita intake rate as the response, and items and individuals as the predictors, and extract the coefficients (and p-values) of each for every regrowth rate and simulation type.

First we access all regrowth levels.

```{r}
# read general fun response and split by sim type
data <- fread("data/data_funresp_general.csv")
```

### Separate data by Scenario and Regrowth

```{r}
# split the data
data_model <- split(data, by = c("sim_type", "regrowth", "variable"))
```

```{r}
# define a function to collect coefficients
do_model <- function(df, ...) {
  mod <- glm(..., data = df)

  cf <- coefficients(mod)

  data.table(cf = cf, vbl = names(cf))
}
```

```{r}
# gather coefficients
model_cf <- Map(function(df) {
  do_model(df = df, "value ~ items + total_agents")
}, df = data_model)
```

```{r}
# read in parameters
params <- unique(data, by = c("sim_type", "regrowth", "variable"))

setnames(params, old = "variable", new = "strategy")

# add list column of coefficients
params[, mod_cf := model_cf]

# unlist as data
sim_coefs <- params[, unlist(mod_cf, recursive = F), 
                    by = list(sim_type, regrowth, strategy)]
```

### Handle variable names

```{r}
# subset columns
sim_coefs <- sim_coefs[stringi::stri_detect(vbl,
  regex = "(items)|(agents)"
), ]

# rename vbl
sim_coefs[, vbl := dplyr::case_when(
  stringi::stri_detect(vbl,
    fixed = "items:total_agents"
  ) ~
  "items * individuals",
  stringi::stri_detect(vbl, fixed = "items") ~ "items",
  # stringi::stri_detect(vbl, fixed = "klepts") ~ "kleptoparasite",
  T ~ "individuals"
)]

# relevel simulation type
sim_coefs[, sim_type := factor(sim_type,
                               levels = c("foragers", "obligate", 
                                          "facultative", "random"))]
```

### Plot variable values

```{r}
fig_coef_intake <- 
  ggplot(sim_coefs[strategy != "pc_intake_total"])+
  geom_hline(yintercept = 0, col = "grey",
             lwd = 0.1, lty = 2)+
  geom_line(aes((regrowth),
                 cf,
                col = c(strategy)))+
  geom_point(aes((regrowth), 
                 cf,
                 col = strategy), 
             size = 3,
             shape = 1, stroke = 1)+
  
  facet_grid(sim_type~vbl, scales = "fixed")+
  scale_colour_manual(
    values = pals::coolwarm(2)
  )+
  theme_test()+
  theme(legend.position = "top")+
  labs(x = "growth rate",
       y = "coefficient",
       col = "scenario")

# save
ggsave(fig_coef_intake,
       filename = "figures/fig_coef_intake_general.png")
```

