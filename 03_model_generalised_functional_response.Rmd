---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Ecology: Intake in relation to individuals and items

We fit a GLM with per-capita intake rate as the response, and items and individuals as the predictors, and extract the coefficients (and p-values) of each for every regrowth rate and simulation type.

## Get libraries

```{r}
# load libs
library(ggplot2)
library(data.table)
library(colorspace)
library(patchwork)
```

## Load data and split

```{r}
# read in data
data = fread("data/results/data_funresp_general.csv")
head(data)
```

```{r}
# split the data
data_model <- split(data, by = c("sim_type", "replicate", "regrowth", "gen", 
                                 "variable"))
```

## Prepare linear model and run

```{r}
# define a function to collect coefficients
do_model <- function(df, ...) {
  mod <- glm(..., data = df)

  cf <- coefficients(mod)

  data.table(cf = cf, vbl = names(cf))
}
```

```{r}
# gather coefficients
model_cf <- Map(function(df) {
  do_model(df = df, "value ~ items + total_agents")
}, df = data_model)
```

## Get model coefficients

```{r}
# read in parameters
params <- unique(data, by = c("sim_type", "regrowth", "variable", 
                              "gen", "replicate"))

setnames(params, old = "variable", new = "strategy")

# add list column of coefficients
params[, mod_cf := model_cf]

# unlist as data
sim_coefs <- params[, unlist(mod_cf, recursive = F), 
                    by = list(sim_type, regrowth, strategy, replicate, gen)]
```

## Handle coefficient names

```{r}
# subset columns
sim_coefs <- sim_coefs[stringi::stri_detect(vbl,
  regex = "(items)|(agents)|(Intercept)"
), ]

# rename vbl
sim_coefs[, vbl := dplyr::case_when(
  stringi::stri_detect(vbl,
    fixed = "items:total_agents"
  ) ~
  "items * individuals",
  stringi::stri_detect(vbl, fixed = "items") ~ "items",
  stringi::stri_detect(vbl, fixed = "Intercept") ~ "intercept",
  # stringi::stri_detect(vbl, fixed = "klepts") ~ "kleptoparasite",
  T ~ "individuals"
)]

# relevel simulation type
sim_coefs[, sim_type := factor(sim_type,
                               levels = c("foragers", "obligate", 
                                          "facultative", "random"))]
```

```{r}
fwrite(sim_coefs, "data/results/data_funresp_gen_coefs.csv")
```

## Plot coefficient values

```{r}
# read in data
data = fread("data/results/data_funresp_gen_coefs.csv")
data = data[strategy != "pc_intake_total" & vbl != "intercept"]
```

```{r}
# make coefficient labels
data$vbl <- factor(data$vbl, labels = c(expression(beta*"2: individuals"), 
                                        expression(beta*"1: items")))

# split by sim type
data <- split(data, by = "sim_type")

# arrange
data <- data[c("foragers", "obligate", "facultative")]

subplots_coef_intake <- Map(function(df) {
  ggplot(df)+
  geom_hline(yintercept = 0, col = "grey",
             lty = 2)+
  geom_smooth(
    aes(regrowth,
        cf,
        col = strategy),
    lwd = 0.2
  )+
  geom_jitter(aes((regrowth), 
                 cf,
                 col = strategy),
             shape = 1)+
  
  facet_grid(~vbl, scales = "fixed",
             labeller = label_parsed)+
  scale_colour_manual(
    values = diverging_hcl(2, "Blue-Red", l = 30, rev = F)
  )+
  scale_x_continuous(breaks = c(0.01, 0.1, 0.25))+
  coord_cartesian(
    # ratio = 0.2,
              xlim = c(0, 0.25),
              ylim = c(-0.25, 2))+
  theme_test()+
  theme(
    axis.text.y = element_text(size = 8),
    axis.title.y = element_text(angle = 90),
    legend.position = "none",
    panel.background = element_rect(
      fill = "grey95"
    )
  )+
  labs(x = "Regrowth rate",
       y = "Coef. value")
}, data)

# wrap
fig_coef_intake <-
  wrap_plots(
    subplots_coef_intake,
    ncol = 3
  )+
  plot_annotation(tag_levels = "a",
                  tag_prefix = "(",
                  tag_suffix = ")")

fig_coef_intake
# save
ggsave(fig_coef_intake,
       width = 12, height = 3,
       filename = "figures/fig_05_coef_intake_general.png")
```
