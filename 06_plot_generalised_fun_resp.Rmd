---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Functional and Aggregative Response

```{r}
library(data.table)
library(ggplot2)
library(colorspace)
library(patchwork)

# summary function
multsum <- function(x) {
  list(mean = mean(x),
       median = median(x),
       sd = sd(x))
}

# get lower value
get_lower <- function(x) {
  as.double(
    stringi::stri_extract_first(x, 
                             regex = "[0-9]+\\.\\d*")
  )
}
```


## Functional Response of Intake to All Predators

### Get data

```{r}
# read general fun response and split by sim type
data <- fread("data_sim/results/data_funresp_agents.csv")

# get specific regrowths
data <- data[regrowth %in% c(0.001, 0.01, 0.05), ]
```

### Summarise data over generations

```{r}
# get mean, median and sd for intake by strategy, rep, and growth
# as well as sim type
data_summary <- data[, unlist(lapply(.SD, multsum), recursive = F),
                     .SDcols = c("value"),
                     by = c("sim_type", "regrowth",
                            "total_agents", "variable")]

# split off total from strategy specific
data_total_intake <- data_summary[variable == "pc_intake_total", ]

# get remainder as sumamry
data_summary <- data_summary[variable != "pc_intake_total", ]
```

### Plot: Per-capita intake by strategy ~ total agents

```{r}
# get numeric value
data_summary[, total_agents_num := get_lower(total_agents)]
data_summary <- split(data_summary, by = "sim_type")
```

```{r}
# make each figure
subfig_fun_response <-
  lapply(data_summary, function(df) {
    ggplot(df[])+
      geom_point(aes(total_agents_num, value.mean,
                     col = variable),
                 # size = 0.5,
                 shape = 1,
                 show.legend = F)+
      facet_grid(sim_type ~ regrowth)+
      kleptomoveMS::theme_custom(base_size = 8)+
      coord_cartesian(ylim = c(0, 0.25),
                      xlim = c(0, 0.75))+
      scale_colour_discrete_diverging(palette = "Blue-Red 2",
                                      rev = F)+
      labs(
        x = "# predators",
        y = "per-capita intake"
      )
  })

# wrap figures together
fig_fun_response <-
  wrap_plots(subfig_fun_response[c(
  "foragers",
  "obligate",
  "facultative"
)],
ncol = 1)

# view figure
fig_fun_response <- 
  fig_fun_response +
  plot_annotation(
    tag_levels = "a",
    tag_prefix = "(",
    tag_suffix = ")"
  ) &
  theme(plot.tag = element_text(face = "bold"))
```

## Functional Response to Different Strategies

### Get data

```{r}
data <- fread("data_sim/results/data_funresp_strategy.csv")
# get specific regrowths
data <- data[regrowth %in% c(0.001, 0.01, 0.05), ]
```

### Subset data and summarise

```{r}
# forager data
data_resp_forager <- data[variable != "pc_intake_total", 
                          unlist(lapply(.SD, multsum), recursive = F),
                          .SDcols = c("value"),
                          by = c("sim_type", "replicate", "regrowth",
                                 "variable", "foragers")]
data_resp_forager[, foragers_num := get_lower(foragers)]

# klept data
data_resp_klept <- data[variable != "pc_intake_total" &
                          sim_type != "foragers", 
                          unlist(lapply(.SD, multsum), recursive = F),
                          .SDcols = c("value"),
                          by = c("sim_type", "replicate", "regrowth",
                                 "variable", "klepts")]
data_resp_klept[, klepts_num := get_lower(klepts)]

# split and append
data_resp_forager <- split(data_resp_forager, by = "sim_type")
data_resp_klept <- split(data_resp_klept, by = "sim_type")
```

### Plot: Function response ~ foragers

```{r}
# make subfigures
subfig_resp_forager <- lapply(data_resp_forager, function(df) {
  ggplot(df)+
  geom_point(aes(foragers_num, value.mean,
                 col = variable),
             shape = 1,
             show.legend = F)+
      facet_grid(sim_type ~ regrowth)+
      kleptomoveMS::theme_custom(base_size = 8)+
      coord_cartesian(xlim = c(0, 0.75),
                      ylim = c(0, 0.3))+
      scale_colour_discrete_diverging(palette = "Blue-Red 2",
                                      rev = F)+
        labs(x = "# foragers",
             y = "per-capita intake")
})

# wrap
fig_resp_forager <-
  wrap_plots(subfig_resp_forager[
  c("foragers", "obligate", "facultative")
], ncol = 1)+
  plot_annotation(
    tag_levels = "a",
    tag_prefix = "(",
    tag_suffix = ")"
  ) &
  theme(plot.tag = element_text(face = "bold"))
```

### Plot: Functional response ~ kleptoparasites

```{r}
# now klepts
# make subfigures
subfig_resp_klept <- 
  lapply(data_resp_klept, function(df) {
  ggplot(df)+
  geom_point(aes(klepts_num, value.mean,
                 col = variable),
             shape = 1,
             show.legend = F)+
      facet_grid(sim_type ~ regrowth)+
      kleptomoveMS::theme_custom(base_size = 8)+
      coord_cartesian(xlim = c(0, 0.75),
                      ylim = c(0, 0.3))+
      scale_colour_discrete_diverging(palette = "Blue-Red 2",
                                      rev = F)+
        labs(x = "# kleptoparasites",
             y = "per-capita intake")
})

# wrap
fig_resp_klepts <- wrap_plots(subfig_resp_klept[
  c("obligate", "facultative")
], ncol = 1)+
  plot_annotation(
    tag_levels = "a",
    tag_prefix = "(",
    tag_suffix = ")"
  ) &
  theme(plot.tag = element_text(face = "bold"))
```

## Compare total and strategy-wise total functional response

### Process response to all agents at r_max = 0.01

```{r}
# collect data at rmax = 0.1
data_funresp_total <- lapply(data_summary, function(x) {
  x[, tag := "by strategy"][regrowth == 0.01, ]
})

# fix names
data_funresp_total <- data_funresp_total[c("foragers", 
                                           "obligate", "facultative")]
names(data_funresp_total) <- sprintf('%s_strat', names(data_funresp_total))
```

```{r}
subfig_funresp_total <- 
  lapply(data_funresp_total, function(df) {
    
    # fix pal
    if (length(unique(df$variable)) == 2) {
      pal <- diverge_hcl(n = 2, palette = "Blue-Red 2")
    } else {
      pal <- "black"
    }
    
    # make plot
    subfig <- 
      ggplot(df)+
      geom_errorbar(aes(total_agents_num,
                        ymin = value.mean - value.sd,
                        ymax = value.mean + value.sd,
                        col = variable),
                    show.legend = F,
                    size = 0.1)+
      geom_point(aes(total_agents_num, value.mean,
                     col = variable),
                 shape = 1,
                 # size = 0.5,
                 show.legend = F)+
      scale_x_sqrt()+
      scale_y_sqrt()+
      facet_grid(~ sim_type)+
      kleptomoveMS::theme_custom(base_size = 8)+
      coord_cartesian(xlim = c(0, 0.75),
                      ylim = c(0, 0.3))+
      scale_colour_manual(values = pal)+
      labs(
        x = "# all individuals",
        y = "per-capita intake"
      )
      
      return(subfig)
  })
```

### Process response to strategies at r_max = 0.01

```{r}
# same for foragers
subfig_resp_forager <- lapply(data_resp_forager, function(df) {
  df <- df[regrowth == 0.01,]
  ggplot(df)+
    geom_errorbar(aes(foragers_num,
                        ymin = value.mean - value.sd,
                        ymax = value.mean + value.sd,
                        col = variable),
                    show.legend = F,
                    size = 0.1)+
  geom_point(aes(foragers_num, value.mean,
                 col = variable),
             shape = 1,
             show.legend = F)+
      facet_grid(~ sim_type)+
      scale_x_sqrt()+
      scale_y_sqrt()+
      kleptomoveMS::theme_custom(base_size = 8)+
      coord_cartesian(xlim = c(0, 0.75),
                      ylim = c(0, 0.3))+
      scale_colour_discrete_diverging(palette = "Blue-Red 2",
                                      rev = F)+
        labs(x = "# foragers",
             y = "per-capita intake")
})

# fix name order
subfig_resp_forager <- subfig_resp_forager[
  c("foragers", "obligate", "facultative")
]

# subset and remake figure
subfig_resp_klept <- 
  lapply(data_resp_klept, function(df) {
    df <- df[regrowth == 0.01, ]
    ggplot(df)+
      geom_errorbar(aes(klepts_num,
                        ymin = value.mean - value.sd,
                        ymax = value.mean + value.sd,
                        col = variable),
                    show.legend = F,
                    size = 0.1)+
      geom_point(aes(klepts_num, value.mean,
                     col = variable),
                 shape = 1,
                 show.legend = F)+
      scale_x_sqrt()+
      scale_y_sqrt()+
      facet_grid(~ sim_type)+
      kleptomoveMS::theme_custom(base_size = 8)+
      coord_cartesian(xlim = c(0, 0.75),
                      ylim = c(0, 0.3))+
      scale_colour_discrete_diverging(palette = "Blue-Red 2",
                                      rev = F)+
      labs(x = "# kleptoparasites",
           y = "per-capita intake")
  })

subfig_resp_klept <- subfig_resp_klept[
  c("obligate", "facultative")
]

```

### Combine figures

```{r}
subfig_all <- append(subfig_funresp_total,
                     values = append(subfig_resp_forager,
                                     subfig_resp_klept))
figure_functional_response <-
  wrap_plots(
  subfig_all,
  design = "ABC\nDEF\n#GH"
)+
  plot_annotation(
    tag_levels = "a",
    tag_prefix = "(",
    tag_suffix = ")"
  ) &
  theme(plot.tag = element_text(face = "bold"))
```

```{r}
# save
ggsave(
  figure_functional_response,
  filename = "figures/fig_04_functional_response.png"
)
```

