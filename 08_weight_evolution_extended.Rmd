---
output: html_document
editor_options: 
  chunk_output_type: console
---
  
# Plot node weight evolution
  
```{r}
# load libs
library(data.table)
library(ggplot2)

# get helper functions
source("code/helper_functions.R")
```

```{r}
# read back in
data <- fread("data/results/data_weight_evolution.csv")

# handle weight value ranges and use UPPER bound
data[, weight_num := 
       stringi::stri_extract_last(weight_value, 
                                  regex = "[-0-9]+\\.\\d{2}")]
# assign numeric
data[, weight_num := as.numeric(weight_num)]
```

```{r}
test <- data[regrowth == 0.05 & 
               sim_type == "facultative"]

test <- test[weight_prop > 0.001, 
             list(n_pos = as.double(sum(weight_num > 0)),
                  n_neg = as.double(sum(weight_num < 0)),
                  p_neg = sum(weight_prop[weight_num < 0]),
                  p_pos = sum(weight_prop[weight_num > 0])),
             by = c("sim_type", "replicate", 
                    "regrowth", "weight_id", "gen")]

test <- na.omit(test)

test[, p_pos_var := n_pos / (n_pos + n_neg)]
test[, n_morphs := n_pos + n_neg]

# test[, c("n_pos", "n_neg") := NULL]

# test[, value := ifelse(variable == "n_neg", -value, value)]
# 
# test[, p_sum := ifelse(variable == "n_neg", -p_neg, p_pos)]

# test[, `:=`(p_pos = NULL, p_neg = NULL)]

ggplot(test, 
       aes(group = replicate))+
  geom_ribbon(
    aes(x = gen, 
        ymin = 1 - p_neg,
        ymax = (1 - p_neg) + (n_pos/50)),
    fill = "dodgerblue",
    alpha = 0.3
  )+
  geom_ribbon(
    aes(x = gen, 
        ymin = 1 - p_neg,
        ymax = (1 - p_neg) - (n_neg/50)),
    fill = "indianred",
    alpha = 0.3
  )+
  geom_line(aes(gen, 1 - p_neg),
            lwd = 0.2)+
  facet_grid(~ weight_id)+
  # scale_fill_viridis_c(option = "B")+
  scale_colour_gradientn(
    colours = c(pals::kovesi.diverging_bkr_55_10_c35(3)),
    # limits = c(-10, 10),
    na.value = "grey90"
  )+
  # scale_y_continuous(breaks = c(-1, 0, 1),
  #                    labels = c("-tive", "0", "+tive"))+
  ggthemes::theme_few(base_family = "sans")+
  labs(x = "generation",
       y = "p(+ve weight)",
       fill = "diversity")

  ggsave(filename = "test.png")
```


## Prepare plots

```{r}
# get label weights
label_wt <- c(
  # sprintf("weight: %s", c(2:8, 99))
  c("m(non-h)", "m(hand)", "m(food)",
    "f(bias)", "f(non-h)", "f(hand)", "f(food)", "f(total)")
)
names(label_wt) <- c(seq(2, 8), 99)

# subset
data <- data[regrowth %in% c(0.001, 0.01, 0.05, 0.1, 0.25)]

# split the data
data2 <- split(data, by = c("sim_type"))

# plot the timeline
plots <- Map(function(le) {
  
  # split by regrowth
  le <- split(le, by = "regrowth")
  
  subfigures <- lapply(le, function(df) {
    # get plot title
    title <- sprintf("scenario: %s\nregrowth: %.*f",
                     unique(df$sim_type),
                     3,
                     unique(df$regrowth)) 
    
    
    df <- df[weight_prop > 0.001, 
             list(n_pos = as.double(sum(weight_num > 0)),
                  n_neg = as.double(sum(weight_num < 0)),
                  p_neg = sum(weight_prop[weight_num < 0]),
                  p_pos = sum(weight_prop[weight_num > 0])),
             by = c("sim_type", "replicate", 
                    "regrowth", "weight_id", "gen")]
    
    
    df <- na.omit(df)

    df[, p_pos_var := n_pos / (n_pos + n_neg)]
    df[, n_morphs := n_pos + n_neg]
    # plot
    ggplot(df, 
           aes(group = replicate))+
      geom_ribbon(
        aes(x = gen, 
            ymin = 1 - p_neg,
            ymax = (1 - p_neg) + (n_pos/50)),
        fill = "dodgerblue",
        alpha = 0.3
      )+
      geom_ribbon(
        aes(x = gen, 
            ymin = 1 - p_neg,
            ymax = (1 - p_neg) - (n_neg/50)),
        fill = "indianred",
        alpha = 0.3
      )+
      geom_line(aes(gen, 1 - p_neg),
                lwd = 0.2)+
      facet_grid(~ weight_id,
                 labeller = labeller(weight_id = label_wt))+
      # scale_fill_viridis_c(option = "B")+
      scale_colour_gradientn(
        colours = c(pals::kovesi.diverging_bkr_55_10_c35(3)),
        # limits = c(-10, 10),
        na.value = "grey90"
      )+
      coord_cartesian(ylim = c(-0.5, 1.5))+
      scale_y_continuous(breaks = c(0, 1),
                         labels = c("0", "1"))+
      ggthemes::theme_tufte(base_family = "sans")+
      theme(axis.text.x = element_blank(),
            axis.title.x = element_text(size= 4),
            panel.grid = element_blank())+
      labs(x = "generation",
           y = "p(+ve weight)",
           title = title)
  })
  
  figure <- patchwork::wrap_plots(subfigures, ncol = 1)
  
  # figure filename
  fig_name <- unique(le[[1]]$sim_type)
  filename = sprintf("figures/fig_node_weight_summary_%s.png",
                     fig_name)
  message(fig_name)
  ggsave(figure,
         filename = filename,
         height = 10,
         width = 20,
         units = "in")
  
  return(figure)
  
}, data2)


```

