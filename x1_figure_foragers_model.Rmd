---
output: html_document
editor_options: 
  chunk_output_type: console
---

load libs

```{r}
library(data.table)

library(ggplot2)
library(patchwork)
library(colorspace)
```

## get data

```{r}
# activity data
data_activity <- fread("data_sim/results/data_strategy_gen.csv")
data_activity <- data_activity[
  sim_type == "foragers" &
    regrowth == 0.01 &
    variable != "stealing"
]
```

## activity budget plot

```{r}
fig_activity <-
ggplot(data_activity[gen <= 50, ]) +
  geom_path(
    aes(
      gen, value,
      colour = variable,
      group = interaction(variable, replicate)
    ),
    position = position_jitter(),
    size = 0.4
  ) +
  scale_colour_manual(
    values = c(
      foraging = "steelblue",
      handling = "seagreen"
    ),
    labels = c(foraging = "Foraging", handling = "Handling"),
    breaks = c("foraging", "handling")
  ) +
  scale_y_continuous(
    # labels = scales::percent,
    breaks = seq(0, 1, 0.25),
    labels = c("0", "0.25", "0.5", "0.75", "1")
  ) +
  scale_x_continuous(
    breaks = c(1, seq(10, 50, 10))
  ) +
  coord_cartesian(
    xlim = c(1, 50),
    ylim = c(0, 1),
    expand = F
  ) +
  theme_classic(base_size = 8)+
  theme(legend.position = "top") +
  labs(
    x = "Generation",
    y = "Prop. population time",
    colour = NULL
  )
```

## figure intake

```{r}
fig_intake <-
  ggplot(
    unique(data_activity[gen <= 50, ],
           by = c("gen", "replicate", "pop_fitness")
    )
  ) +
  geom_path(
    aes(gen, pop_fitness,
        group = replicate
    ),
    position = position_jitter(),
    size = 0.4
  ) +
  scale_x_continuous(
    breaks = c(1, seq(10, 50, 10))
  ) +
  coord_cartesian(
    xlim = c(1, 50),
    ylim = c(0, 50),
    expand = F
  ) +
  theme_classic(base_size = 8)+
  labs(
    x = "Generation",
    y = "Population intake"
  )
```

## get matching data

```{r}
# raw correlation data
data_match = fread("data_sim/results/data_matching_rule.csv")
data_match = data_match[sim_type == "foragers" & regrowth == 0.01, ]

# smoothed data
data_match_smooth = fread("data_sim/results/data_matching_rule_smooth.csv")[
  sim_type == "foragers" & regrowth == 0.01,
]
```

```{r}
fig_matching =
  ggplot()+
  geom_hline(
    yintercept = 0,
    col = "red"
  )+
  geom_point(
    data = data_match,
    aes(
      x = gen,
      y = cf,
      fill = cfp <= 0.05
    ),
    show.legend = F,
    shape = 21
  )+
  geom_smooth(
    data = data_match[cfp <= 0.05, ],
    aes(gen, cf),
    colour = "steelblue",
    method = "gam"
  )+
  scale_fill_brewer(
    palette = "Blues"
  )+
  theme_classic(base_size = 8)+
  coord_cartesian(
    ylim = c(-0.5, 0.5),
    xlim = c(0, 50),
    expand = F
  )+
  xlim(0, 50)+
  labs(x = "Generation", 
       y = "Corr. indivs. - potential intake")
```

## correlation with quality

```{r}
# raw correlation data
data_quality = fread("data_sim/results/data_quality_matching_rule.csv")
data_quality = data_quality[sim_type == "foragers" & regrowth == 0.01, ]
```

```{r}
fig_matching_quality =
  ggplot()+
  geom_hline(
    yintercept = 0,
    col = "red"
  )+
  geom_point(
    data = data_quality,
    aes(
      x = gen,
      y = cf,
      fill = cfp <= 0.05
    ),
    show.legend = F,
    shape = 21
  )+
  geom_smooth(
    data = data_quality[cfp <= 0.05, ],
    aes(gen, cf),
    colour = "steelblue",
    method = "gam"
  )+
  scale_fill_brewer(
    palette = "Blues"
  )+
  theme_classic(base_size = 8)+
  coord_cartesian(
    ylim = c(-0.5, 0.5),
    xlim = c(0, 50),
    expand = F
  )+
  xlim(0, 50)+
  labs(x = "Generation", 
       y = "Corr. indivs. - cell quality")
```

prepare landscape at 0 and 25

```{r}
# get landscape data
data_land <- fread("data_sim/results/data_landscape_item_count_1_50.csv")
data_land <- data_land[sim_type == "foragers", ]

# read agent data
data_agent <- fread("data_sim/results/data_agent_count_1_50.csv")[
  sim_type == "foragers",
]
```

plot landscape foragers model

```{r}
fig_land_foragers <-
  ggplot(data_land) +
  geom_tile(aes(x, y, fill = items)) +
  geom_point(
    data = data_agent[agents > 0, ],
    aes(x, y, size = agents),
    shape = 1,
    col = "grey20"
  ) +
  facet_grid(~gen,
    labeller = label_both
  ) +
  scale_fill_distiller(
    palette = "YlGnBu",
    limits = c(1, NA),
    na.value = "white",
    direction = 1
  ) +
  coord_equal(expand = F) +
  kleptomoveMS::theme_custom(landscape = T, base_size = 6) +
  theme(legend.position = "bottom")+
  labs(fill = "# Items", size = "# Indiv.")
```

## Figure 2 Foragers model

wrap figures together

```{r}
figure_2_forager_model <-
  wrap_plots(
    fig_activity, fig_intake, 
    fig_land_foragers,
    fig_matching, fig_matching_quality,
    design = "AABB\nCCCC\nDDEE"
  ) +
    plot_annotation(
      tag_levels = "A"
    ) &
    theme(plot.tag = element_text(
      face = "bold",
      size = 12
    ))
```

save figure

```{r}
ggsave(figure_2_forager_model,
  filename = "figures/fig_02.png",
  height = 150, width = 125, units = "mm"
)
```

